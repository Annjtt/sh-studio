# UNIVERSAL TELEGRAM BOT ARCHITECTURE TEMPLATE

## 1. Проектирование и анализ
- Сбор бизнес-требований и сценариев (MVP и beyond)
- Проработка пользовательских и административных flow
- Определение внешних интеграций (API, платежи, CRM и т.д.)

## 2. Структура проекта
```
project_root/
  bot/
    core/         # ядро, DI, permissions, utils
    services/     # бизнес-логика, интеграции, временные сервисы (кэш, rate limit, корзина и др.)
    steps/user/   # пользовательские сценарии
    steps/admin/  # административные сценарии
    interfaces/   # абстракции для сервисов
    locales/      # централизованная локализация (ru.json, en.json, ...)
    tests/        # unit, async, integration, e2e, тесты локализации
  docs/           # документация, схемы, инструкции
  .env.example    # пример переменных окружения
  requirements.txt
  docker-compose.yml
  README.md
```

## 3. Ключевые паттерны и сервисы
- Асинхронные сервисы (redis.asyncio, aiohttp и др.)
- Dependency Injection (core/di.py, singleton-ы, сброс и моки для тестов)
- Rate Limiting, кэш, временные данные — через Redis
- Валидация и нормализация пользовательских данных
- Централизованная локализация (l10n(key, user_id), json-файлы)
- Разделение flows: user/admin

## 4. Best Practices
- Все секреты — только в .env и CI/CD Secrets
- Покрытие unit/integration/e2e тестами (pytest, pytest-asyncio)
- Моки всех внешних сервисов (Redis, Telegram API, ...)
- Сброс singleton-ов и DI перед тестами
- Тест на полноту локализации (все ключи во всех языках)
- Линтинг, автотесты, автодеплой через CI/CD (GitHub Actions)
- Документация: архитектура, сценарии, инструкции
- Логирование ошибок и действий (logging, Sentry)
- Проверка зависимостей на уязвимости (safety, dependabot)

## 5. Масштабирование и отказоустойчивость
- Redis для временных данных (rate limit, кэш, корзины, сессии)
- Возможность вынести Redis и БД на отдельные серверы
- Горизонтальное масштабирование бота (несколько воркеров)
- Мониторинг (Sentry, Prometheus, Grafana)
- Бэкапы и аварийное восстановление

## 6. Безопасность
- Ограничение доступа к админским функциям (whitelist ID, роли)
- Валидация всех входных данных
- Ограничение доступа к Redis/БД по IP, паролю, TLS
- Rate limiting для защиты от спама и атак
- Логирование всех критичных действий

## 7. Тестирование и автоматизация
- Покрытие unit, async, integration, e2e (pytest, pytest-asyncio)
- Моки всех внешних сервисов (Redis, Telegram API, ...)
- Сброс singleton-ов и DI перед тестами
- Тест на полноту локализации (все ключи во всех языках)
- e2e тесты пользовательских и админских сценариев
- GitHub Actions: автозапуск тестов, coverage, артефакты
- Линтинг, автодеплой, отчёты о покрытии

## 8. Алгоритм создания и настройки бота
1. Проанализировать бизнес-требования и сценарии
2. Спроектировать структуру каталогов и сервисов
3. Настроить .env, docker-compose, requirements.txt
4. Реализовать ядро (core), DI, permissions
5. Реализовать сервисы (cart, rate limiter, cache, интеграции)
6. Реализовать шаги сценариев (steps/user, steps/admin)
7. Покрыть тестами (unit, async, integration, e2e, локализация)
8. Настроить CI/CD (тесты, линтинг, автодеплой)
9. Оформить документацию (README, diagrams, usage)
10. Провести нагрузочное тестирование и аудит безопасности

---

**Этот файл — универсальный шаблон архитектуры Telegram-бота для любых проектов. Используй как propmt-дизайн для новых решений!** 